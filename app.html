<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lars vom Mars</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: url('mars_background.png');
            background-size: cover;
            background-position: center;
            color: white;
            font-family: Arial, sans-serif;
            position: relative;
            /* Updated 2025-03-20 */
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px black;
            text-align: center;
            margin-top: 40px;
            color: rgba(255,255,255,0.5);
            padding: 20px;
            line-height: 1.4;
        }

        .login-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,192,203,0.6) !important;
            width: 100px !important;
            height: 100px !important;
            font-size: 16px !important;  
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-background {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        
        .lyrics-container {
            padding: 30px;
            border-radius: 15px;
            margin: 20px;
            width: 80%;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            text-align: center;
            font-size: 1.8em;
            font-family: "Comic Sans MS", "Comic Sans", cursive;
            position: fixed;
            bottom: 250px;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .lyrics-container.visible {
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lyrics-line {
            animation: fadeIn 2s ease-out forwards;
            opacity: 0;
        }

        .buttons {
            display: flex;
            gap: 40px;
            margin: 20px;
            margin-bottom: 50px;
            position: fixed;
            bottom: 20px;  
        }

        .button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.2s;
            color: black;
            font-weight: bold;
        }

        .button:hover {
            transform: scale(1.1);
        }

        .button.audiobook {
            background: rgba(255,255,0,0.6);  
        }

        .button.video {
            background: rgba(173,216,230,0.6);
        }

        .button.music {
            background: rgba(255,160,160,0.6);
        }

        .button.sounds {
            background: rgba(144,238,144,0.6);
        }

        /* Kinderfreundlichere Styles */
        .chapter-item {
            background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
            padding: 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 3px solid transparent;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .chapter-item:hover {
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .chapter-item.active {
            background: linear-gradient(45deg, #fad0c4 0%, #ff9a9e 99%, #ff9a9e 100%);
            border: 3px solid #fff;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .chapter-number {
            background: #fff;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.4em;
            color: #ff9a9e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chapter-title {
            font-size: 1.3em;
            margin-bottom: 5px;
            color: #444;
            font-weight: bold;
        }

        .chapter-description {
            font-size: 1em;
            color: #666;
        }

        .chapter-status {
            font-size: 1.4em;
            margin-left: auto;
            width: 30px;
            text-align: center;
        }

        .audio-player {
            background: linear-gradient(45deg, #fad0c4 0%, #ff9a9e 99%, #ff9a9e 100%);
            padding: 20px;
            border-radius: 25px;
            margin-top: 20px;
            text-align: center;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 3px solid #fff;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
        }

        .audio-button {
            background: #fff;
            border: none;
            color: #ff9a9e;
            padding: 20px 35px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 28px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .audio-button:hover {
            background: #fff;
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .now-playing {
            color: #444;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: bold;
        }

        /* Blasen-Stil für das Modal */
        .content-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
            width: 54vh;  
            height: 54vh;
            animation: float 5s ease-in-out infinite;
            border: 8px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(8px);
        }

        /* Innerer Container für den Inhalt */
        .modal-content {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-title {
            color: #444;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
        }

        .chapter-list {
            max-height: 35vh;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 95%;
            margin: 0 auto;
        }

        /* Audio-Player zentriert */
        .audio-player {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 25px;
            margin: 15px auto;
            text-align: center;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 3px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(5px);
            width: 90%;
        }

        .chapter-item {
            padding: 12px;
            font-size: 0.9em;
        }

        .audio-button {
            padding: 15px 25px;
            font-size: 24px;
        }

        /* Glanzeffekt für die Seifenblase */
        .bubble-shine {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 50%;
            background: linear-gradient(
                135deg,
                rgba(255,255,255,0.4) 0%,
                rgba(255,255,255,0.1) 50%,
                transparent 100%
            );
            pointer-events: none;
        }

        /* Kleine Blasen noch transparenter */
        .bubble-decoration {
            position: absolute;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
            backdrop-filter: blur(2px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        /* Schwebeanimation für die Blase */
        @keyframes float {
            0% {
                transform: translate(-50%, -50%);
            }
            50% {
                transform: translate(-50%, -54%);
            }
            100% {
                transform: translate(-50%, -50%);
            }
        }

        /* Innerer Container für den Inhalt */
        .modal-content {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-title {
            color: #444;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
        }

        /* Kleine Blasen-Dekoration */
        .bubble-decoration {
            position: absolute;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
        }

        .bubble-1 {
            width: 25px;
            height: 25px;
            top: 10%;
            left: 10%;
            animation-delay: -1s;
        }

        .bubble-2 {
            width: 20px;
            height: 20px;
            top: 20%;
            right: 15%;
            animation-delay: -2s;
        }

        .bubble-3 {
            width: 15px;
            height: 15px;
            bottom: 15%;
            right: 10%;
            animation-delay: -3s;
        }

        /* Anpassung der Schließen-Taste */
        .close-button {
            position: absolute;
            top: 20px;
            right: 30px;
            background: white;
            border: none;
            color: #8ec5fc;
            font-size: 24px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .close-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Hauptblasen-Animation - von unten starten */
        @keyframes mainBubbleFloat {
            0% {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, 50%);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -150%);
                opacity: 0;
            }
        }

        /* Angepasste Animation für Kapitel-Blasen innerhalb der Hauptblase */
        @keyframes bubbleRiseInside {
            0% {
                transform: translateY(120%) scale(0.8);
                opacity: 0;
            }
            20% {
                transform: translateY(60%) scale(0.9);
                opacity: 1;
            }
            80% {
                transform: translateY(-60%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-120%) scale(0.9);
                opacity: 0;
            }
        }

        .content-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, 
                rgba(224,195,252,0.5) 0%, 
                rgba(142,197,252,0.5) 100%
            );
            padding: 25px;
            border-radius: 50%;
            box-shadow: 
                0 10px 20px rgba(0,0,0,0.1),
                inset 0 0 100px rgba(255,255,255,0.5);
            z-index: 1000;
            width: 54vh;
            height: 54vh;
            animation: mainBubbleFloat 25s ease-in-out infinite;
            border: 8px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(8px);
            overflow: hidden;
        }

        .content-modal.paused {
            animation-play-state: paused;
        }

        .content-modal.paused .chapter-item {
            animation-play-state: paused;
        }

        /* Kapitel-Blasen innerhalb der Hauptblase */
        .chapter-item {
            background: linear-gradient(45deg, 
                rgba(255,154,158,0.4) 0%, 
                rgba(250,208,196,0.4) 100%
            );
            padding: 15px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            width: 120px;
            height: 120px;
            margin: 10px;
            transition: all 0.3s ease;
            border: 4px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            animation: bubbleRiseInside 20s ease-in-out infinite;
        }

        /* JavaScript für das Anhalten der Animation */
        .chapter-item {
            background: linear-gradient(45deg, 
                rgba(255,154,158,0.4) 0%, 
                rgba(250,208,196,0.4) 100%
            );
            padding: 15px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            width: 120px;
            height: 120px;
            margin: 10px;
            transition: all 0.3s ease;
            border: 4px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
            animation: bubbleRiseInside 20s ease-in-out infinite;
        }

        /* Angepasste Kapitel-Positionen */
        .chapter-item:nth-child(1) {
            animation-delay: 0s;
            left: -10%;
        }

        .chapter-item:nth-child(2) {
            animation-delay: -7s;
            left: 0;
        }

        .chapter-item:nth-child(3) {
            animation-delay: -14s;
            left: 10%;
        }

        /* Container für die Kapitel */
        .chapter-list {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: visible;
        }

        /* Import Button Styling */
        .import-button {
            background: linear-gradient(45deg, rgba(152, 251, 152, 0.6) 0%, rgba(102, 204, 102, 0.6) 100%);
            color: #444;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .import-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .import-button i {
            margin-right: 5px;
        }

        /* Import feedback styling */
        .import-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 10px;
            display: none;
            font-size: 0.9em;
            animation: fadeInOut 5s ease-in-out;
        }

        .import-success {
            background-color: rgba(144, 238, 144, 0.3);
            color: #006400;
        }

        .import-error {
            background-color: rgba(255, 182, 193, 0.3);
            color: #8B0000;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* File input styling - hidden but accessible */
        #audiobook-file-input {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Eltern-Login Button entfernt - Version 2025-03-20 -->
    <div class="modal-background" id="modalBackground"></div>
    <h1>WILLKOMMEN<br>IN DER WELT VON LARS VOM MARS</h1>
    
    <div class="lyrics-container">
        <!-- Hier kommen die Liedtexte -->
    </div>
    
    <div class="buttons">
        <button class="button audiobook" onclick="handleButtonClick('audiobook')">Hörbuch</button>
        <button class="button video" onclick="handleButtonClick('video')">Video</button>
        <button class="button music" onclick="handleButtonClick('music')">Musik</button>
        <button class="button sounds" onclick="handleButtonClick('sounds')">Action</button>  
    </div>

    <div class="content-modal" id="audiobookModal">
        <div class="bubble-shine"></div>
        <button class="close-button" onclick="closeModal('audiobookModal')">×</button>
        <div class="modal-content">
            <h2 class="modal-title">🎧 Lars vom Mars - Die komplette Geschichte</h2>
            
            <!-- Import Button hinzugefügt -->
            <button class="import-button" onclick="document.getElementById('audiobook-file-input').click()">
                <i>📂</i> Hörbuch importieren
            </button>
            <input type="file" id="audiobook-file-input" accept="audio/*" multiple onchange="importAudiobooks(this.files)">
            <div id="import-feedback" class="import-feedback"></div>
            
            <div class="audio-player" id="chapterPlayer">
                <div class="now-playing">Kapitel wird geladen...</div>
                <div class="audio-controls">
                    <button class="audio-button" onclick="toggleChapter()">▶️</button>
                    <button class="audio-button" onclick="stopChapter()">⏹️</button>
                </div>
            </div>

            <div class="chapter-list">
                <div class="chapter-item" data-chapter="1" onclick="playChapter(1)">
                    <div class="chapter-number">1</div>
                    <div class="chapter-info">
                        <div class="chapter-title">Lars startet zur Erde</div>
                    </div>
                </div>
                
                <div class="chapter-item" data-chapter="2" onclick="playChapter(2)">
                    <div class="chapter-number">2</div>
                    <div class="chapter-info">
                        <div class="chapter-title">Lars im Raumschiff</div>
                    </div>
                </div>
                
                <div class="chapter-item" data-chapter="3" onclick="playChapter(3)">
                    <div class="chapter-number">3</div>
                    <div class="chapter-info">
                        <div class="chapter-title">Lars trifft einen Stern</div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <div class="content-modal" id="videoModal">
        <button class="close-button" onclick="closeModal('videoModal')">×</button>
        <h2 class="modal-title">🎬 Lars vom Mars - Videoabenteuer</h2>
        <div class="chapter-list">
            <div class="chapter-item">
                <div class="chapter-number">1</div>
                <div class="chapter-info">
                    <div class="chapter-title">Lars' erste Reise</div>
                    <div class="chapter-description">Ein spannendes Abenteuer beginnt, als Lars sein Raumschiff startet.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Audio-Player initialisieren
        let audioPlayer = null;
        let isPlaying = false;
        let soundIsPlaying = false;

        // Quack-Sound
        const quackSound = new Audio('quack_sound.mp3');

        // Button-Klick-Handler
        function handleButtonClick(type) {
            if (type === 'music') {
                toggleMusic();
            } else if (type === 'sounds') {
                playQuackSound();
            } else if (type === 'audiobook') {
                document.getElementById('audiobookModal').style.display = 'block';
                document.getElementById('modalBackground').style.display = 'block';
            } else if (type === 'video') {
                document.getElementById('videoModal').style.display = 'block';
                document.getElementById('modalBackground').style.display = 'block';
            }
        }

        // Quack-Sound abspielen
        function playQuackSound() {
            if (soundIsPlaying) {
                quackSound.pause();
                quackSound.currentTime = 0;
                soundIsPlaying = false;
            } else {
                quackSound.play();
                soundIsPlaying = true;
                // Nach 10 Sekunden stoppen
                setTimeout(() => {
                    quackSound.pause();
                    quackSound.currentTime = 0;
                    soundIsPlaying = false;
                }, 10000);
            }
        }

        // Musik abspielen/pausieren
        function toggleMusic() {
            if (!audioPlayer) {
                audioPlayer = new Audio('lars_vom_mars_song.wav');
            }
            
            if (isPlaying) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0; // Zurück zum Start
                isPlaying = false;
                document.querySelector('.lyrics-container').textContent = '';
                document.querySelector('.lyrics-container').classList.remove('visible');
                // Alle Timeouts löschen wenn Musik stoppt
                if (window.timeouts) {
                    window.timeouts.forEach(timeout => clearTimeout(timeout));
                }
            } else {
                audioPlayer.currentTime = 0; // Immer vom Start beginnen
                audioPlayer.play();
                isPlaying = true;
                window.timeouts = [];  // Array für unsere Timeouts

                // Container vorbereiten
                const container = document.querySelector('.lyrics-container');
                container.innerHTML = '';

                // Verse 1 (nach 10 Sekunden)
                window.timeouts.push(setTimeout(() => {
                    const lines = [
                        "In stummen Nächten singt Lars, der Frosch allein.",
                        "Er schwingt auf seinen Träumen, sehnt sich nach daheim,",
                        "In ferner Stille, hallt leise sein Gesang,",
                        "Ein Lied von Wüsten, die einst nach Heimat klang."
                    ];
                    
                    container.classList.add('visible');
                    lines.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        div.className = 'lyrics-line';
                        div.style.animationDelay = `${index * 4.0}s`;
                        container.appendChild(div);
                    });
                }, 10000));

                // Chorus 1 (nach 36 Sekunden)
                window.timeouts.push(setTimeout(() => {
                    const lines = [
                        "Lars vom Mars, Lars vom Mars,",
                        "sein Herz so groß, sein Blick so klar.",
                        "Er singt vom roten Staub der Ewigkeit,",
                        "träumt von Heimat, doch die bleibt so weit."
                    ];
                    
                    container.innerHTML = '';
                    lines.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        div.className = 'lyrics-line';
                        div.style.animationDelay = `${index * 4.0}s`;
                        container.appendChild(div);
                    });
                }, 36000));

                // Verse 2 (nach 56 Sekunden)
                window.timeouts.push(setTimeout(() => {
                    const lines = [
                        "Sein Lied fliegt durch die Stürme aus feurigem Sand,",
                        "verloren in den Dünen, in einem fremden Land.",
                        "Die Krater sind wie Narben, gezeichnet vom All,",
                        "und Lars fragt den Himmel: Wann endet mein Fall?"
                    ];
                    
                    container.innerHTML = '';
                    lines.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        div.className = 'lyrics-line';
                        div.style.animationDelay = `${index * 4.0}s`;
                        container.appendChild(div);
                    });
                }, 56000));

                // Chorus 2 (nach 84 Sekunden)
                window.timeouts.push(setTimeout(() => {
                    const lines = [
                        "Lars vom Mars, Lars vom Mars,",
                        "sein Herz so groß, sein Blick so klar.",
                        "Er singt vom roten Staub der Ewigkeit,",
                        "träumt von Heimat, doch die bleibt so weit."
                    ];
                    
                    container.innerHTML = '';
                    lines.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        div.className = 'lyrics-line';
                        div.style.animationDelay = `${index * 4.0}s`;
                        container.appendChild(div);
                    });
                }, 84000));

                // Bridge (nach 102 Sekunden)
                window.timeouts.push(setTimeout(() => {
                    const lines = [
                        "Vielleicht hört ihn der Wind, der vom Olymp weht,",
                        "vielleicht singt er für Sterne, die niemand je versteht.",
                        "Vielleicht trägt ihn der Traum durch die Unendlichkeit,",
                        "bis jemand ruft: Lars, es ist soweit!"
                    ];
                    
                    container.innerHTML = '';
                    lines.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        div.className = 'lyrics-line';
                        div.style.animationDelay = `${index * 4.0}s`;
                        container.appendChild(div);
                    });
                }, 102000));

                // Chorus Outro (nach 132 Sekunden)
                window.timeouts.push(setTimeout(() => {
                    const lines = [
                        "Lars vom Mars, Lars vom Mars,",
                        "sein Herz so groß, sein Blick so klar.",
                        "Er singt vom roten Staub der Ewigkeit,",
                        "träumt von Heimat, doch die bleibt so weit."
                    ];
                    
                    container.innerHTML = '';
                    lines.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.textContent = line;
                        div.className = 'lyrics-line';
                        div.style.animationDelay = `${index * 4.0}s`;
                        container.appendChild(div);
                    });
                }, 132000));
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById('modalBackground').style.display = 'none';
        }

        function showLogin() {
            alert('Diese Funktion steht derzeit nicht zur Verfügung');
        }

        // Klick außerhalb schließt Modal
        document.getElementById('modalBackground').onclick = function() {
            document.getElementById('audiobookModal').style.display = 'none';
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('modalBackground').style.display = 'none';
        };

        // Hörbuch-Player
        let chapterAudio = null;
        let currentChapter = null;
        let chapterPlaying = false;

        function playChapter(number) {
            // Entferne aktive Markierung von allen Kapiteln
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Markiere ausgewähltes Kapitel als aktiv
            document.querySelector(`.chapter-item:nth-child(${number})`).classList.add('active');

            // Stoppe vorherige Wiedergabe
            if (chapterAudio) {
                chapterAudio.pause();
                chapterAudio.currentTime = 0;
                chapterPlaying = false;
                document.querySelector('.audio-button').textContent = '▶️';
            }

            // Zeige Player
            const player = document.getElementById('chapterPlayer');
            player.style.display = 'block';

            // Aktualisiere "Now Playing"
            const chapterTitle = document.querySelector(`.chapter-item:nth-child(${number}) .chapter-title`).textContent;
            document.querySelector('.now-playing').textContent = `${chapterTitle}`;

            // Lade Kapitel
            chapterAudio = new Audio(`chapter${number}.mp3`);
            currentChapter = number;
        }

        function toggleChapter() {
            if (!chapterAudio) return;

            const playButton = document.querySelector('.audio-button');
            if (chapterPlaying) {
                chapterAudio.pause();
                chapterPlaying = false;
                playButton.textContent = '▶️';
            } else {
                // Versuche das Audio zu laden und abzuspielen
                chapterAudio.load();  // Lade das Audio neu
                const playPromise = chapterAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Wiedergabe erfolgreich gestartet
                        chapterPlaying = true;
                        playButton.textContent = '⏸️';
                    }).catch(error => {
                        console.error('Fehler beim Abspielen:', error);
                        alert('Ups! Das Kapitel konnte nicht abgespielt werden.');
                        chapterPlaying = false;
                        playButton.textContent = '▶️';
                    });
                }
            }
        }

        function stopChapter() {
            if (!chapterAudio) return;
            
            chapterAudio.pause();
            chapterAudio.currentTime = 0;
            chapterPlaying = false;
            document.querySelector('.audio-button').textContent = '▶️';
        }

        // Beim Schließen des Modals auch Audio stoppen
        const originalCloseModal = closeModal;
        closeModal = function(modalId) {
            if (modalId === 'audiobookModal') {
                stopChapter();
            }
            originalCloseModal(modalId);
        };

        // Beim Laden der Seite alle Modals verstecken
        window.onload = function() {
            document.getElementById('audiobookModal').style.display = 'none';
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('modalBackground').style.display = 'none';
        };

        function stopAnimations() {
            const modal = document.querySelector('.content-modal');
            modal.classList.add('paused');
        }

        // Event-Listener für Kapitel-Klicks
        document.querySelectorAll('.chapter-item').forEach(item => {
            item.addEventListener('click', function(e) {
                stopAnimations();
                playChapter(this.dataset.chapter);
            });
        });

        // IndexedDB für Offline-Speicherung der Hörbücher initialisieren
        let db;
        const dbName = 'LarsVomMarsDB';
        const request = indexedDB.open(dbName, 1);

        request.onerror = function(event) {
            console.error('Database error:', event.target.error);
        };

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            // Speicher für Hörbücher erstellen, wenn er noch nicht existiert
            if (!db.objectStoreNames.contains('audiobooks')) {
                const store = db.createObjectStore('audiobooks', { keyPath: 'id' });
                store.createIndex('by_title', 'title', { unique: false });
                store.createIndex('by_chapter', 'chapter', { unique: false });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            loadImportedAudiobooks();
        };

        // Funktion zum Importieren von Hörbüchern
        function importAudiobooks(files) {
            if (!files.length) return;
            
            const feedback = document.getElementById('import-feedback');
            feedback.className = 'import-feedback';
            feedback.style.display = 'block';
            feedback.textContent = 'Import wird durchgeführt...';
            
            let filesProcessed = 0;
            let filesImported = 0;

            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('audio/')) {
                    filesProcessed++;
                    checkCompletion();
                    return;
                }

                // Datei einlesen
                const reader = new FileReader();
                reader.onload = function(e) {
                    // In IndexedDB speichern
                    const transaction = db.transaction(['audiobooks'], 'readwrite');
                    const store = transaction.objectStore('audiobooks');
                    
                    // Kapitel-Nummer aus dem Dateinamen extrahieren (wenn möglich)
                    let chapter = 0;
                    const chapterMatch = file.name.match(/\d+/);
                    if (chapterMatch) {
                        chapter = parseInt(chapterMatch[0]);
                    } else {
                        chapter = index + 1; // Fallback: Indexnummer + 1
                    }
                    
                    const audiobook = {
                        id: 'chapter_' + chapter,
                        title: file.name.replace(/\.\w+$/, ''),
                        chapter: chapter,
                        data: e.target.result,
                        type: file.type,
                        dateAdded: new Date()
                    };
                    
                    const request = store.put(audiobook);
                    
                    request.onsuccess = function() {
                        filesImported++;
                        filesProcessed++;
                        checkCompletion();
                    };
                    
                    request.onerror = function(event) {
                        console.error('Error importing file:', event.target.error);
                        filesProcessed++;
                        checkCompletion();
                    };
                };
                
                reader.onerror = function() {
                    console.error('Error reading file');
                    filesProcessed++;
                    checkCompletion();
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            function checkCompletion() {
                if (filesProcessed === files.length) {
                    if (filesImported > 0) {
                        feedback.className = 'import-feedback import-success';
                        feedback.textContent = `${filesImported} Hörbuch(er) erfolgreich importiert! Die Bibliothek wird aktualisiert.`;
                        // Importierte Hörbücher anzeigen
                        loadImportedAudiobooks();
                    } else {
                        feedback.className = 'import-feedback import-error';
                        feedback.textContent = 'Keine Audiodateien importiert. Bitte überprüfen Sie die ausgewählten Dateien.';
                    }
                    
                    // Feedback nach 5 Sekunden ausblenden
                    setTimeout(() => {
                        feedback.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Importierte Hörbücher laden und anzeigen
        function loadImportedAudiobooks() {
            if (!db) return;
            
            const transaction = db.transaction(['audiobooks'], 'readonly');
            const store = transaction.objectStore('audiobooks');
            const index = store.index('by_chapter');
            const request = index.getAll();
            
            request.onsuccess = function(event) {
                const audiobooks = event.target.result;
                if (audiobooks.length > 0) {
                    // Kapitel-Liste leeren
                    const chapterList = document.querySelector('.chapter-list');
                    chapterList.innerHTML = '';
                    
                    // Sortieren nach Kapitelnummer
                    audiobooks.sort((a, b) => a.chapter - b.chapter);
                    
                    // Kapitel zur Liste hinzufügen
                    audiobooks.forEach(book => {
                        const chapterItem = document.createElement('div');
                        chapterItem.className = 'chapter-item';
                        chapterItem.dataset.chapter = book.chapter;
                        chapterItem.dataset.id = book.id;
                        chapterItem.innerHTML = `
                            <div class="chapter-number">${book.chapter}</div>
                            <div class="chapter-info">
                                <div class="chapter-title">${book.title}</div>
                            </div>
                        `;
                        
                        chapterItem.addEventListener('click', function() {
                            stopAnimations();
                            playImportedChapter(book.id, book.chapter);
                        });
                        
                        chapterList.appendChild(chapterItem);
                    });
                }
            };
            
            request.onerror = function(event) {
                console.error('Error loading audiobooks:', event.target.error);
            };
        }

        // Importiertes Kapitel abspielen
        function playImportedChapter(id, number) {
            // Entferne aktive Markierung von allen Kapiteln
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Markiere ausgewähltes Kapitel als aktiv
            document.querySelector(`[data-id="${id}"]`).classList.add('active');

            // Stoppe vorherige Wiedergabe
            if (chapterAudio) {
                chapterAudio.pause();
                chapterAudio = null;
            }
            
            // Lade das Kapitel aus der Datenbank
            const transaction = db.transaction(['audiobooks'], 'readonly');
            const store = transaction.objectStore('audiobooks');
            const request = store.get(id);
            
            request.onsuccess = function(event) {
                const audiobook = event.target.result;
                if (audiobook) {
                    // Zeige Player
                    const player = document.getElementById('chapterPlayer');
                    player.style.display = 'block';
                    
                    // Aktualisiere "Now Playing"
                    document.querySelector('.now-playing').textContent = audiobook.title;
                    document.querySelector('.audio-button').textContent = '▶️';
                    
                    // Audio erstellen und abspielen
                    const blob = new Blob([audiobook.data], { type: audiobook.type });
                    const url = URL.createObjectURL(blob);
                    chapterAudio = new Audio(url);
                    currentChapter = number;
                    chapterPlaying = false;
                }
            };
            
            request.onerror = function(event) {
                console.error('Error loading audiobook:', event.target.error);
            };
        }
    </script>
</body>
</html>